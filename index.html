<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra v19</title>
    <style>
        :root { --c-blue: #003366; --c-bg: #f4f6f9; --c-gray: #e0e0e0; --c-red: #ff4d4d; --c-green: #2ecc71; --c-gold: #f1c40f; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--c-bg); font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; }
        
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--c-bg); z-index: 10; }
        .screen.active { display: flex; }

        .top-ui { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; min-height: 70px; z-index: 100; }
        
        .stats-bar { display: flex; gap: 10px; }
        .stat-item { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-item.coins { color: var(--c-gold); font-weight: 800; }
        
        .board-zone { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; transition: 0.2s; }
        
        /* –≠–§–§–ï–ö–¢–´ */
        @keyframes shake { 0%,100% { transform: translateX(0); } 10%,30%,50%,70%,90% { transform: translateX(-5px); } 20%,40%,60%,80% { transform: translateX(5px); } }
        @keyframes redFlash { 0% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; } 50% { box-shadow: 0 0 50px rgba(255, 77, 77, 0.6), inset 0 0 20px rgba(255, 77, 77, 0.2); border-color: var(--c-red); } 100% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; } }
        @keyframes coinBounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        #board { 
            width: 100%; aspect-ratio: 1; background: white; border-radius: 25px; 
            position: relative; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border: 3px solid transparent; 
            transition: background 0.3s;
        }
        
        .board-zone.error-shake #board { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both, redFlash 0.5s ease-out; }

        .arrow-box { position: absolute; cursor: pointer; z-index: 2; transition: opacity 0.1s; }
        .arrow-svg { width: 100%; height: 100%; overflow: visible; display: block; }
        
        .p-line { fill: none; stroke: var(--c-blue); stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.2s; }
        .p-head { fill: var(--c-blue); transition: fill 0.2s; }

        .arrow-box.error-arr .p-line { stroke: var(--c-red); }
        .arrow-box.error-arr .p-head { fill: var(--c-red); }

        /* UI */
        #scr-home { align-items: center; justify-content: center; }
        .logo { font-size: 4rem; font-weight: 900; color: var(--c-blue); margin-bottom: 5px; }
        .play-btn { width: 100px; height: 100px; background: var(--c-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,51,102,0.2); cursor: pointer; }
        
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-icon { opacity: 0.3; color: var(--c-blue); cursor: pointer; }
        .nav-icon.active { opacity: 1; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–∞–≥–∞–∑–∏–Ω */
        .leaderboard { max-height: 400px; overflow-y: auto; margin: 20px 0; }
        .leader-row { display: flex; justify-content: space-between; padding: 10px 15px; margin: 5px 0; background: white; border-radius: 10px; align-items: center; }
        .leader-row.you { background: var(--c-blue); color: white; }
        .leader-rank { font-weight: bold; width: 30px; }
        .leader-name { flex: 1; margin: 0 10px; }
        .leader-score { font-weight: bold; color: var(--c-gold); }
        
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .shop-item { background: white; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .shop-item:hover { transform: scale(1.05); }
        .shop-item.locked { opacity: 0.5; }
        .shop-price { color: var(--c-gold); font-weight: bold; margin-top: 5px; }
        
        .coin-animation { position: fixed; z-index: 10000; font-size: 24px; font-weight: bold; color: var(--c-gold); animation: coinBounce 1s ease-out forwards; pointer-events: none; }
        
        /* VICTORY SCREEN */
        #scr-win { align-items: center; justify-content: center; text-align: center; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 1500; overflow: hidden; }
        #confetti-canvas { position: absolute; inset: 0; pointer-events: none; width: 100%; height: 100%; z-index: 1; }
        .win-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .win-title { font-size: 3.5rem; font-weight: 900; color: var(--c-blue); margin-bottom: 40px; transform: scale(0); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 2px 10px rgba(0,51,102,0.1); }
        .win-title.show { transform: scale(1); }
        .win-reward { color: var(--c-gold); font-size: 1.5rem; font-weight: bold; margin: 10px 0; }
        
        .btn-row { display: flex; gap: 20px; margin-top: 20px; }
        .big-btn { padding: 15px 30px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .big-btn:active { transform: scale(0.95); }
        .btn-menu { background: var(--c-gray); color: #555; }
        .btn-next { background: var(--c-blue); color: white; box-shadow: 0 8px 20px rgba(0,51,102,0.25); }
    </style>
</head>
<body>

<div id="app">
    <div class="top-ui" id="main-header">
        <div class="stats-bar">
            <div class="stat-item coins" id="coins-display">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                <span id="coins-count">0</span>
            </div>
            <div class="stat-item" id="level-display">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                <span id="level-count">1</span>
            </div>
        </div>
        <div id="btn-back" style="display:none" onclick="App.nav('home')">
            <svg width="30" height="30" fill="var(--c-blue)" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>
    </div>

    <div id="scr-home" class="screen active">
        <div class="logo">Arrows</div>
        <div id="player-name" style="margin-bottom: 5px; font-weight: bold; color: var(--c-blue);"></div>
        <div id="lvl-label" style="margin-bottom: 30px; font-weight: bold; color: var(--c-blue); opacity: 0.6;">LEVEL 1</div>
        <div class="play-btn" onclick="App.play()">
            <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="board-zone"><div id="board"></div></div>
    </div>
    
    <div id="scr-win" class="screen">
        <canvas id="confetti-canvas"></canvas>
        <div class="win-content">
            <div id="win-msg" class="win-title">Victory!</div>
            <div id="win-reward" class="win-reward">+50 ü™ô</div>
            <div class="btn-row">
                <button class="big-btn btn-menu" id="btn-win-menu" onclick="App.nav('home')">Menu</button>
                <button class="big-btn btn-next" id="btn-win-next" onclick="App.nextLvl()">Next</button>
            </div>
        </div>
    </div>

    <div id="scr-stats" class="screen" style="padding: 20px; overflow-y: auto;">
        <h2 style="color:var(--c-blue); text-align:center; margin:20px 0;" id="t-leaderboard">Leaderboard</h2>
        <div class="leaderboard" id="leaderboard-list"></div>
    </div>

    <div id="scr-shop" class="screen" style="padding: 20px; overflow-y: auto;">
        <h2 style="color:var(--c-blue); text-align:center; margin:20px 0;" id="t-shop">Shop</h2>
        <div class="shop-grid" id="shop-items"></div>
        <div style="text-align:center; margin-top:30px; color:#666; padding:20px;">
            <div id="t-comingsoon">üé® New skins coming soon! üöÄ</div>
            <div style="font-size:0.9rem; margin-top:10px;" id="t-shopdesc">Earn coins by completing levels and unlock awesome skins!</div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-icon" id="n-stats" onclick="App.nav('stats')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></div>
        <div class="nav-icon active" id="n-home" onclick="App.nav('home')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>
        <div class="nav-icon" id="n-shop" onclick="App.nav('shop')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg></div>
    </div>
</div>

<script>
// ====================== –°–ò–°–¢–ï–ú–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –ú–û–ù–ï–¢ ======================
const GameStats = {
    userData: {
        coins: 0,
        maxLevel: 1,
        username: "Player",
        userId: null,
        skins: ["default"],
        selectedSkin: "default"
    },
    
    // –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
    translations: {
        ru: {
            leaderboard: "–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤",
            shop: "–ú–∞–≥–∞–∑–∏–Ω",
            comingsoon: "üé® –ù–æ–≤—ã–µ —Å–∫–∏–Ω—ã —Å–∫–æ—Ä–æ! üöÄ",
            shopdesc: "–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –º–æ–Ω–µ—Ç—ã, –ø—Ä–æ—Ö–æ–¥—è —É—Ä–æ–≤–Ω–∏, –∏ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫—Ä—É—Ç—ã–µ —Å–∫–∏–Ω—ã!",
            coins: "–ú–æ–Ω–µ—Ç—ã",
            level: "–£—Ä–æ–≤–µ–Ω—å",
            you: "–í—ã",
            rank: "–ú–µ—Å—Ç–æ",
            name: "–ò–º—è",
            score: "–û—á–∫–∏",
            loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
            skin_default: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π",
            skin_fire: "–û–≥–Ω–µ–Ω–Ω—ã–π",
            skin_ice: "–õ–µ–¥—è–Ω–æ–π",
            skin_neon: "–ù–µ–æ–Ω–æ–≤—ã–π",
            price: "–¶–µ–Ω–∞",
            buy: "–ö—É–ø–∏—Ç—å",
            owned: "–í–ª–∞–¥–µ–µ—Ç–µ",
            select: "–í—ã–±—Ä–∞—Ç—å"
        },
        en: {
            leaderboard: "Leaderboard",
            shop: "Shop",
            comingsoon: "üé® New skins coming soon! üöÄ",
            shopdesc: "Earn coins by completing levels and unlock awesome skins!",
            coins: "Coins",
            level: "Level",
            you: "You",
            rank: "Rank",
            name: "Name",
            score: "Score",
            loading: "Loading...",
            skin_default: "Default",
            skin_fire: "Fire",
            skin_ice: "Ice",
            skin_neon: "Neon",
            price: "Price",
            buy: "Buy",
            owned: "Owned",
            select: "Select"
        },
        zh: {
            leaderboard: "ÊéíË°åÊ¶ú",
            shop: "ÂïÜÂ∫ó",
            comingsoon: "üé® Êñ∞ÁöÆËÇ§Âç≥Â∞ÜÊé®Âá∫ÔºÅüöÄ",
            shopdesc: "ÈÄöËøáÂÆåÊàêÂÖ≥Âç°ËµöÂèñÈáëÂ∏ÅÂπ∂Ëß£ÈîÅÁÇ´ÈÖ∑ÁöÆËÇ§ÔºÅ",
            coins: "ÈáëÂ∏Å",
            level: "Á≠âÁ∫ß",
            you: "‰Ω†",
            rank: "ÊéíÂêç",
            name: "ÂêçÂ≠ó",
            score: "ÂàÜÊï∞",
            loading: "Âä†ËΩΩ‰∏≠...",
            skin_default: "ÈªòËÆ§",
            skin_fire: "ÁÅ´ÁÑ∞",
            skin_ice: "ÂÜ∞Èúú",
            skin_neon: "ÈúìËôπ",
            price: "‰ª∑Ê†º",
            buy: "Ë¥≠‰π∞",
            owned: "Â∑≤Êã•Êúâ",
            select: "ÈÄâÊã©"
        }
    },
    
    // –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤
    shopItems: [
        { id: "default", name: { ru: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π", en: "Default", zh: "ÈªòËÆ§" }, price: 0, color: "#003366" },
        { id: "fire", name: { ru: "–û–≥–Ω–µ–Ω–Ω—ã–π", en: "Fire", zh: "ÁÅ´ÁÑ∞" }, price: 500, color: "#ff4d4d" },
        { id: "ice", name: { ru: "–õ–µ–¥—è–Ω–æ–π", en: "Ice", zh: "ÂÜ∞Èúú" }, price: 750, color: "#3498db" },
        { id: "neon", name: { ru: "–ù–µ–æ–Ω–æ–≤—ã–π", en: "Neon", zh: "ÈúìËôπ" }, price: 1000, color: "#9b59b6" },
        { id: "gold", name: { ru: "–ó–æ–ª–æ—Ç–æ–π", en: "Golden", zh: "ÈáëËâ≤" }, price: 1500, color: "#f1c40f" },
        { id: "rainbow", name: { ru: "–†–∞–¥—É–∂–Ω—ã–π", en: "Rainbow", zh: "ÂΩ©Ëôπ" }, price: 2000, color: "#00cc99" }
    ],
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    init() {
        this.loadFromStorage();
        this.detectTelegramUser();
        this.updateUI();
    },
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram Web App
    detectTelegramUser() {
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            const user = tg.initDataUnsafe?.user;
            
            if (user) {
                this.userData.username = user.username ? `@${user.username}` : `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}`;
                this.userData.userId = user.id;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
                this.saveToLeaderboard();
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('player-name').textContent = this.userData.username;
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
    loadFromStorage() {
        const saved = localStorage.getItem('arrows_stats');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.userData = { ...this.userData, ...data };
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
            }
        }
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
    saveToStorage() {
        localStorage.setItem('arrows_stats', JSON.stringify(this.userData));
    },
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    addCoins(amount) {
        const oldCoins = this.userData.coins;
        this.userData.coins += amount;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–Ω–µ—Ç
        this.showCoinAnimation(amount);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        this.updateCoinsDisplay();
        this.saveToStorage();
        
        return this.userData.coins;
    },
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–Ω–µ—Ç
    showCoinAnimation(amount) {
        const coin = document.createElement('div');
        coin.className = 'coin-animation';
        coin.textContent = `+${amount} ü™ô`;
        coin.style.left = '50%';
        coin.style.top = '50%';
        coin.style.transform = 'translate(-50%, -50%)';
        
        document.body.appendChild(coin);
        
        setTimeout(() => {
            coin.remove();
        }, 1000);
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
    updateLevel(level) {
        if (level > this.userData.maxLevel) {
            this.userData.maxLevel = level;
            this.saveToStorage();
            this.saveToLeaderboard();
        }
        this.updateLevelDisplay();
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–Ω–µ—Ç
    updateCoinsDisplay() {
        document.getElementById('coins-count').textContent = this.userData.coins;
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
    updateLevelDisplay() {
        document.getElementById('level-count').textContent = this.userData.maxLevel;
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ UI
    updateUI() {
        this.updateCoinsDisplay();
        this.updateLevelDisplay();
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π)
    saveToLeaderboard() {
        const leaderboard = JSON.parse(localStorage.getItem('arrows_leaderboard') || '[]');
        
        // –ò—â–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userIndex = leaderboard.findIndex(u => u.userId === this.userData.userId);
        
        const userEntry = {
            userId: this.userData.userId,
            username: this.userData.username,
            score: this.userData.maxLevel,
            lastPlayed: Date.now()
        };
        
        if (userIndex !== -1) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (userEntry.score > leaderboard[userIndex].score) {
                leaderboard[userIndex] = userEntry;
            }
        } else {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            leaderboard.push(userEntry);
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º
        leaderboard.sort((a, b) => b.score - a.score);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø-50
        const top50 = leaderboard.slice(0, 50);
        localStorage.setItem('arrows_leaderboard', JSON.stringify(top50));
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
    loadLeaderboard() {
        const leaderboard = JSON.parse(localStorage.getItem('arrows_leaderboard') || '[]');
        const t = this.translations[App.state.lang] || this.translations.en;
        
        let html = '';
        
        if (leaderboard.length === 0) {
            html = `<div style="text-align:center; padding:40px; color:#999;">${t.loading}</div>`;
        } else {
            leaderboard.forEach((user, index) => {
                const isYou = user.userId === this.userData.userId;
                html += `
                    <div class="leader-row ${isYou ? 'you' : ''}">
                        <div class="leader-rank">${index + 1}</div>
                        <div class="leader-name">${user.username}</div>
                        <div class="leader-score">${user.score} ${t.level}</div>
                    </div>
                `;
            });
        }
        
        document.getElementById('leaderboard-list').innerHTML = html;
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
    loadShop() {
        const t = this.translations[App.state.lang] || this.translations.en;
        let html = '';
        
        this.shopItems.forEach(item => {
            const owned = this.userData.skins.includes(item.id);
            const selected = this.userData.selectedSkin === item.id;
            const canBuy = this.userData.coins >= item.price;
            
            html += `
                <div class="shop-item ${!owned && !canBuy ? 'locked' : ''}" 
                     onclick="GameStats.handleShopItem('${item.id}')"
                     style="border: 2px solid ${selected ? item.color : 'transparent'}">
                    <div style="width:60px;height:60px;margin:0 auto 10px;background:${item.color};border-radius:10px;"></div>
                    <div style="font-weight:bold;">${item.name[t.lang] || item.name.en}</div>
                    <div class="shop-price">
                        ${owned ? t.owned : `${item.price} ü™ô`}
                    </div>
                </div>
            `;
        });
        
        document.getElementById('shop-items').innerHTML = html;
    },
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
    handleShopItem(skinId) {
        const item = this.shopItems.find(s => s.id === skinId);
        const t = this.translations[App.state.lang] || this.translations.en;
        
        // –£–∂–µ –≤–ª–∞–¥–µ–µ–º —Å–∫–∏–Ω–æ–º
        if (this.userData.skins.includes(skinId)) {
            this.userData.selectedSkin = skinId;
            this.saveToStorage();
            this.loadShop();
            alert(`${t.select}: ${item.name[t.lang] || item.name.en}`);
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –º–æ–Ω–µ—Ç
        if (this.userData.coins >= item.price) {
            if (confirm(`${t.buy} "${item.name[t.lang] || item.name.en}" ${t.for} ${item.price} ü™ô?`)) {
                this.userData.coins -= item.price;
                this.userData.skins.push(skinId);
                this.userData.selectedSkin = skinId;
                this.saveToStorage();
                this.updateUI();
                this.loadShop();
                alert(`${t.success}! ${item.name[t.lang] || item.name.en} ${t.unlocked}`);
            }
        } else {
            alert(`${t.notenough}: ${item.price - this.userData.coins} ü™ô ${t.moreneeded}`);
        }
    },
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∫–∏–Ω–∞ –∫ –∏–≥—Ä–µ
    applySkin() {
        const item = this.shopItems.find(s => s.id === this.userData.selectedSkin);
        if (item) {
            document.documentElement.style.setProperty('--c-blue', item.color);
        }
    }
};

// ====================== –ö–û–ù–§–ï–¢–¢–ò –î–í–ò–ñ–û–ö ======================
const Confetti = {
    canvas: null, ctx: null, w: 0, h: 0, particles: [], active: false,
    colors: ['#ff4d4d', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6', '#00cc99', '#ff6600'],
    init() {
        this.canvas = document.getElementById('confetti-canvas');
        this.ctx = this.canvas.getContext('2d');
        window.addEventListener('resize', () => this.resize());
    },
    resize() {
        const parent = this.canvas.parentElement;
        this.w = this.canvas.width = parent.offsetWidth;
        this.h = this.canvas.height = parent.offsetHeight;
    },
    start() {
        this.resize();
        this.active = true;
        this.particles = [];
        for(let i=0; i<150; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 25 + 10;
            this.particles.push({
                x: this.w / 2, y: this.h / 2,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                c: this.colors[Math.floor(Math.random() * this.colors.length)],
                s: Math.random() * 10 + 5,
                d: Math.random() * 0.04 + 0.95,
                r: Math.random() * 360, vr: (Math.random() - 0.5) * 10
            });
        }
        this.loop();
    },
    stop() { this.active = false; if(this.ctx) this.ctx.clearRect(0,0,this.w,this.h); },
    loop() {
        if(!this.active) return;
        this.ctx.clearRect(0,0,this.w,this.w);
        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.8;
            p.vx *= p.d; p.vy *= p.d;
            p.r += p.vr; p.s *= 0.995;
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            this.ctx.rotate(p.r * Math.PI / 180);
            this.ctx.fillStyle = p.c;
            this.ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
            this.ctx.restore();
            if(p.y > this.h + 50 || p.s < 1) this.particles.splice(i, 1);
        });
        if(this.particles.length > 0) requestAnimationFrame(() => this.loop());
        else this.active = false;
    }
};

// ====================== –ì–ï–û–ú–ï–¢–†–ò–Ø ======================
const Geo = {
    tracks: {
        'R': [[5,30], [40,30], [40,50], [1500,50]],
        'L': [[55,30], [20,30], [20,10], [-1500,10]],
        'U': [[30,55], [30,20], [10,20], [10,-1500]],
        'D': [[30,5], [30,40], [50,40], [50,1500]]
    },
    getPointAtDist(points, dist) {
        let currentDist = 0;
        for(let i=0; i<points.length-1; i++) {
            let dx = points[i+1][0]-points[i][0], dy = points[i+1][1]-points[i][1];
            let segLen = Math.hypot(dx, dy);
            if(currentDist + segLen >= dist) {
                let ratio = (dist - currentDist) / segLen;
                return { x: points[i][0] + dx * ratio, y: points[i][1] + dy * ratio, angle: Math.atan2(dy, dx) * 180 / Math.PI };
            }
            currentDist += segLen;
        }
        let last = points[points.length-1];
        return {x: last[0], y: last[1], angle: 0};
    },
    getSegmentPath(points, distStart, distEnd) {
        let d = "", currentDist = 0;
        let pStart = this.getPointAtDist(points, Math.max(0, distStart));
        d += `M ${pStart.x} ${pStart.y}`;
        for(let i=0; i<points.length-1; i++) {
            let segLen = Math.hypot(points[i+1][0]-points[i][0], points[i+1][1]-points[i][1]);
            if(currentDist + segLen > distStart && currentDist + segLen < distEnd) d += ` L ${points[i+1][0]} ${points[i+1][1]}`;
            currentDist += segLen;
        }
        let pEnd = this.getPointAtDist(points, distEnd);
        d += ` L ${pEnd.x} ${pEnd.y}`;
        return { d, head: pEnd };
    }
};

// ====================== –û–°–ù–û–í–ù–û–ô –ö–û–î –ò–ì–†–´ ======================
const App = {
    state: { maxLvl: 1, lives: 3, timers: [], lang: 'ru', sound: true, vib: true, savedLevels: {} },
    curNum: 1,
    trans: {
        ru: { lang: "–Ø–∑—ã–∫", rec: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", lvl: "–£–†–û–í–ï–ù–¨", sound: "–ó–≤—É–∫", vib: "–í–∏–±—Ä–∞—Ü–∏—è", heart: "–°–µ—Ä–¥—Ü–µ", menu: "–ú–µ–Ω—é", next: "–î–∞–ª–µ–µ" },
        en: { lang: "Language", rec: "Recovery", lvl: "LEVEL", sound: "Sound", vib: "Vibration", heart: "Heart", menu: "Menu", next: "Next" },
        zh: { lang: "ËØ≠Ë®Ä", rec: "ÊÅ¢Â§çÊó∂Èó¥", lvl: "ÂÖ≥Âç°", sound: "Â£∞Èü≥", vib: "ÊåØÂä®", heart: "ÂøÉ", menu: "ËèúÂçï", next: "‰∏ã‰∏ÄÂÖ≥" }
    },
    praise: {
        ru: ["–û—Ç–ª–∏—á–Ω–æ!", "–°—É–ø–µ—Ä!", "–ü–æ–±–µ–¥–∞!", "–ì–µ–Ω–∏–∞–ª—å–Ω–æ!", "–ö–ª–∞—Å—Å!", "–£—Ä–∞!", "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ!"],
        en: ["Excellent!", "Amazing!", "Victory!", "Genius!", "Great!", "Wow!", "Fantastic!"],
        zh: ["Â§™Ê£í‰∫Ü!", "ÂÆåÁæé!", "ËÉúÂà©!", "Â§©Êâç!", "Â•ΩÊûÅ‰∫Ü!", "Âìá!", "Á≤æÂΩ©!"]
    },
    audioCtx: null,
    busy: false,

    init() {
        const d = localStorage.getItem('arrows_pro_v19');
        if (d) this.state = {...this.state, ...JSON.parse(d)};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        GameStats.init();
        
        this.updateUI();
        Confetti.init();
        setInterval(() => this.tick(), 1000);
        
        const unlock = () => {
            if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            window.removeEventListener('touchstart', unlock);
            window.removeEventListener('click', unlock);
        };
        window.addEventListener('touchstart', unlock);
        window.addEventListener('click', unlock);
    },

    save() { localStorage.setItem('arrows_pro_v19', JSON.stringify(this.state)); },

    updateUI() {
        const t = this.translations[this.state.lang] || this.translations.ru;
        document.getElementById('lives-count').innerText = this.state.lives;
        document.getElementById('lvl-label').innerText = `${t.lvl} ${this.state.maxLvl}`;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤
        document.getElementById('t-leaderboard').textContent = t.leaderboard;
        document.getElementById('t-shop').textContent = t.shop;
        document.getElementById('t-comingsoon').textContent = t.comingsoon;
        document.getElementById('t-shopdesc').textContent = t.shopdesc;
        
        document.getElementById('btn-win-menu').innerText = t.menu;
        document.getElementById('btn-win-next').innerText = t.next;
    },

    nav(scr) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-' + scr).classList.add('active');
        document.getElementById('main-header').style.visibility = (scr==='home' || scr==='game') ? 'visible' : 'hidden';
        document.getElementById('btn-back').style.display = (scr==='game') ? 'block' : 'none';
        document.querySelectorAll('.nav-icon').forEach(i => i.classList.toggle('active', i.id === 'n-'+scr));
        
        if(scr !== 'win') Confetti.stop();
        
        if(scr === 'stats') {
            GameStats.loadLeaderboard();
        } else if(scr === 'shop') {
            GameStats.loadShop();
        }
        
        document.querySelector('.board-zone').classList.remove('error-shake');
    },

    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ playAudio, vibrate, play, nextLvl –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

    showWin() {
        if(this.curNum === this.state.maxLvl) this.state.maxLvl++;
        
        // –ù–∞–≥—Ä–∞–¥–∞: 50 –º–æ–Ω–µ—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        const coinsEarned = 50;
        const newCoins = GameStats.addCoins(coinsEarned);
        GameStats.updateLevel(this.state.maxLvl);
        
        this.save();
        this.updateUI();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
        document.getElementById('win-reward').textContent = `+${coinsEarned} ü™ô`;
        
        const arr = this.praise[this.state.lang];
        const txt = arr[Math.floor(Math.random() * arr.length)];
        const title = document.getElementById('win-msg');
        title.innerText = txt;
        title.classList.remove('show');
        
        this.nav('win');
        setTimeout(() => {
            this.playAudio('victory');
            this.vibrate('victory');
            Confetti.start();
            title.classList.add('show');
        }, 100);
    },

    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.onload = () => {
    App.init();
    GameStats.applySkin();
};

// –î–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
window.GameStats = GameStats;
</script>
</body>
</html>
