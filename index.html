<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra</title>
    <style>
        /* ... –≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ ... */
    </style>
</head>
<body>

<div id="app">
    <!-- ... –≤–µ—Å—å HTML –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ ... -->
</div>

<script>
// API Configuration - –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô URL!
const API_BASE_URL = 'https://–≤–∞—à-–Ω–∏–∫.pythonanywhere.com/api'; // –ò–ª–∏ –¥—Ä—É–≥–æ–π –≤–∞—à —Å–µ—Ä–≤–µ—Ä

// --- CONFETTI ENGINE ---
const Confetti = {
    // ... –∫–æ–¥ Confetti –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ ...
};

// --- GEOMETRY ENGINE ---
const Geo = {
    // ... –∫–æ–¥ Geo –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ ...
};

// Shop Items Database
const ShopItems = {
    // ... –∫–æ–¥ ShopItems –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ ...
};

// --- APP LOGIC ---
const App = {
    state: { 
        maxLvl: 1, 
        lives: 3, 
        timers: [], 
        lang: 'ru', 
        sound: true, 
        vib: true, 
        savedLevels: {},
        // Telegram data
        tgUserId: null,
        tgUsername: null,
        tgFirstName: null,
        tgLastName: null,
        tgConnected: false,
        // Server data
        coins: 0,
        skins: ['default'],
        selectedSkin: 'default',
        selectedBoard: 'default',
        selectedEffect: 'none'
    },
    curNum: 1,
    boardSize: 5,
    trans: {
        // ... –∫–æ–¥ trans –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ ...
    },
    praise: {
        ru: ["–û—Ç–ª–∏—á–Ω–æ!", "–°—É–ø–µ—Ä!", "–ü–æ–±–µ–¥–∞!", "–ì–µ–Ω–∏–∞–ª—å–Ω–æ!", "–ö–ª–∞—Å—Å!", "–£—Ä–∞!", "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ!"],
        en: ["Excellent!", "Amazing!", "Victory!", "Genius!", "Great!", "Wow!", "Fantastic!"],
        zh: ["Â§™Ê£í‰∫Ü!", "ÂÆåÁæé!", "ËÉúÂà©!", "Â§©Êâç!", "Â•ΩÊûÅ‰∫Ü!", "Âìá!", "Á≤æÂΩ©!"]
    },
    audioCtx: null,
    busy: false,

    init() {
        const d = localStorage.getItem('arrows_pro_v19');
        if (d) {
            const saved = JSON.parse(d);
            this.state = {...this.state, ...saved};
        }
        
        // Check for Telegram WebApp initData
        this.initTelegramWebApp();
        
        this.updateUI();
        Confetti.init();
        setInterval(() => this.tick(), 1000);
        
        const unlock = () => {
            if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            window.removeEventListener('touchstart', unlock);
            window.removeEventListener('click', unlock);
        };
        window.addEventListener('touchstart', unlock);
        window.addEventListener('click', unlock);
    },

    initTelegramWebApp() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ Telegram WebApp
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp
            tg.ready();
            tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = tg.initDataUnsafe?.user;
            
            if (user) {
                this.state.tgUserId = user.id;
                this.state.tgUsername = user.username || null;
                this.state.tgFirstName = user.first_name || null;
                this.state.tgLastName = user.last_name || null;
                this.state.tgConnected = true;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
                let displayName = '';
                if (this.state.tgUsername) {
                    displayName = `@${this.state.tgUsername}`;
                } else if (this.state.tgFirstName) {
                    displayName = this.state.tgFirstName;
                    if (this.state.tgLastName) {
                        displayName += ` ${this.state.tgLastName}`;
                    }
                } else {
                    displayName = `Player${user.id.toString().slice(-4)}`;
                }
                
                this.state.tgUsername = displayName;
                
                console.log('Telegram user connected:', {
                    id: user.id,
                    username: this.state.tgUsername,
                    first_name: user.first_name,
                    last_name: user.last_name
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
                this.loadUserData();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Telegram
                tg.sendData(JSON.stringify({
                    action: 'user_connected',
                    user_id: user.id,
                    username: this.state.tgUsername
                }));
            } else {
                console.log('No user data in Telegram WebApp');
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            tg.BackButton.onClick(() => {
                this.nav('home');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É MainButton –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            tg.MainButton.setText('Play Game');
            tg.MainButton.onClick(() => {
                this.play();
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–º—É
            tg.setHeaderColor('#003366');
            tg.setBackgroundColor('#f4f6f9');
        } else {
            console.log('Not in Telegram WebApp');
            // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            // this.state.tgUserId = 123456789;
            // this.state.tgUsername = 'TestPlayer';
            // this.state.tgConnected = true;
        }
    },

    async loadUserData() {
        if (!this.state.tgUserId) return;
        
        try {
            console.log('Loading user data for ID:', this.state.tgUserId);
            
            const response = await fetch(`${API_BASE_URL}/get_user_data`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ 
                    user_id: this.state.tgUserId,
                    username: this.state.tgUsername
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    this.state.coins = data.coins || 0;
                    this.state.maxLvl = data.max_level || 1;
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∏–∫–Ω–µ–π–º —Å —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ Telegram –Ω–∏–∫–Ω–µ–π–º
                    this.state.tgUsername = data.username || this.state.tgUsername;
                    this.state.skins = data.skins || ['default'];
                    this.state.selectedSkin = data.selected_skin || 'default';
                    
                    this.updateUI();
                    this.save();
                    
                    console.log('User data loaded successfully');
                } else {
                    console.error('Server returned error:', data.error);
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –µ–≥–æ
                    if (data.error === 'User not found') {
                        await this.registerUser();
                    }
                }
            } else {
                console.error('HTTP error:', response.status);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    },

    async registerUser() {
        if (!this.state.tgUserId || !this.state.tgUsername) return;
        
        try {
            console.log('Registering new user:', this.state.tgUserId, this.state.tgUsername);
            
            const response = await fetch(`${API_BASE_URL}/register_user`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ 
                    user_id: this.state.tgUserId,
                    username: this.state.tgUsername,
                    first_name: this.state.tgFirstName,
                    last_name: this.state.tgLastName
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    console.log('User registered successfully');
                    // –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await this.loadUserData();
                }
            }
        } catch (error) {
            console.error('Error registering user:', error);
        }
    },

    async updateScore() {
        if (!this.state.tgUserId || !this.state.tgUsername) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/update_score`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    user_id: this.state.tgUserId,
                    username: this.state.tgUsername,
                    level: this.state.maxLvl,
                    coins_earned: 20
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.state.coins = data.coins;
                    this.updateUI();
                    console.log('Score updated successfully');
                }
            }
        } catch (error) {
            console.error('Error updating score:', error);
        }
    },

    async loadLeaderboard() {
        try {
            document.getElementById('leaderboard-loading').style.display = 'flex';
            document.getElementById('leaderboard-list').style.display = 'none';
            document.getElementById('leaderboard-error').style.display = 'none';
            
            const response = await fetch(`${API_BASE_URL}/leaderboard`);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Leaderboard data:', data);
                
                if (data.success) {
                    this.renderLeaderboard(data.leaderboard);
                    document.getElementById('leaderboard-loading').style.display = 'none';
                    document.getElementById('leaderboard-list').style.display = 'block';
                }
            } else {
                throw new Error(`Server error: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading leaderboard:', error);
            document.getElementById('leaderboard-loading').style.display = 'none';
            document.getElementById('leaderboard-error').style.display = 'block';
            document.getElementById('leaderboard-error').innerText = this.trans[this.state.lang].errorLoadData + ': ' + error.message;
        }
    },

    renderLeaderboard(leaderboard) {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        const t = this.trans[this.state.lang];
        
        if (!leaderboard || leaderboard.length === 0) {
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">' + 
                           'No players yet. Be the first!' + '</div>';
            return;
        }
        
        leaderboard.forEach((player, index) => {
            const row = document.createElement('div');
            const isCurrentUser = player.user_id == this.state.tgUserId;
            row.className = `leader-row ${isCurrentUser ? 'leader-you' : ''}`;
            
            const rank = document.createElement('div');
            rank.className = 'leader-rank';
            if (index === 0) rank.innerHTML = 'üëë';
            else if (index === 1) rank.innerHTML = 'ü•à';
            else if (index === 2) rank.innerHTML = 'ü•â';
            else rank.innerHTML = (index + 1).toString();
            
            const name = document.createElement('div');
            name.className = 'leader-name';
            name.innerText = player.username || `Player${player.user_id}`;
            if (isCurrentUser) {
                name.innerHTML += ' <span style="color: var(--c-blue); font-size: 0.8em;">(You)</span>';
            }
            
            const levels = document.createElement('div');
            levels.className = 'leader-levels';
            levels.innerText = `${player.score} ${t.levels}`;
            
            row.appendChild(rank);
            row.appendChild(name);
            row.appendChild(levels);
            list.appendChild(row);
        });
    },

    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ (save, updateUI, nav, showStatsScreen –∏ —Ç.–¥.) ...

    showWin() {
        // Add coins
        const coinsEarned = 20;
        this.state.coins += coinsEarned;
        
        if(this.curNum === this.state.maxLvl) this.state.maxLvl++;
        
        this.save();
        this.updateUI();
        
        // Update score on server if connected
        if (this.state.tgConnected) {
            this.updateScore();
        }
        
        // Show coins animation
        this.showCoinsAnimation(coinsEarned);
        
        const arr = this.praise[this.state.lang];
        const txt = arr[Math.floor(Math.random() * arr.length)];
        const title = document.getElementById('win-msg');
        title.innerText = txt;
        title.classList.remove('show');
        
        document.getElementById('coins-earned-amount').innerText = coinsEarned;
        
        this.nav('win');
        setTimeout(() => {
            this.playAudio('victory');
            this.vibrate('victory');
            Confetti.start();
            title.classList.add('show');
        }, 100);
    },

    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏–≥—Ä—ã ...

};
window.onload = () => App.init();
</script>
</body>
</html>
