<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra v19</title>
    <style>
        :root { --c-blue: #003366; --c-bg: #f4f6f9; --c-gray: #e0e0e0; --c-red: #ff4d4d; --c-green: #2ecc71; --c-gold: #f1c40f; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--c-bg); font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; }
        
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--c-bg); z-index: 10; }
        .screen.active { display: flex; }

        .top-ui { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; min-height: 70px; z-index: 100; }
        
        .stats-bar { display: flex; gap: 10px; }
        .stat-item { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-item.coins { color: var(--c-gold); font-weight: 800; }
        .lives-pill { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.1s; }
        .lives-pill:active { transform: scale(0.95); }
        
        .board-zone { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; transition: 0.2s; }
        
        @keyframes shake { 0%,100% { transform: translateX(0); } 10%,30%,50%,70%,90% { transform: translateX(-5px); } 20%,40%,60%,80% { transform: translateX(5px); } }
        @keyframes redFlash { 0% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; } 50% { box-shadow: 0 0 50px rgba(255, 77, 77, 0.6), inset 0 0 20px rgba(255, 77, 77, 0.2); border-color: var(--c-red); } 100% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; } }
        @keyframes coinBounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        #board { 
            width: 100%; aspect-ratio: 1; background: white; border-radius: 25px; 
            position: relative; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border: 3px solid transparent; 
            transition: background 0.3s;
        }
        
        .board-zone.error-shake #board { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both, redFlash 0.5s ease-out; }

        .arrow-box { position: absolute; cursor: pointer; z-index: 2; transition: opacity 0.1s; }
        .arrow-svg { width: 100%; height: 100%; overflow: visible; display: block; }
        
        .p-line { fill: none; stroke: var(--c-blue); stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.2s; }
        .p-head { fill: var(--c-blue); transition: fill 0.2s; }

        .arrow-box.error-arr .p-line { stroke: var(--c-red); }
        .arrow-box.error-arr .p-head { fill: var(--c-red); }

        #scr-home { align-items: center; justify-content: center; }
        .logo { font-size: 4rem; font-weight: 900; color: var(--c-blue); margin-bottom: 5px; }
        .play-btn { width: 100px; height: 100px; background: var(--c-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,51,102,0.2); cursor: pointer; }
        
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-icon { opacity: 0.3; color: var(--c-blue); cursor: pointer; }
        .nav-icon.active { opacity: 1; }

        .set-row { background: white; margin: 8px 20px; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; }
        .toggle { width: 46px; height: 26px; background: var(--c-gray); border-radius: 13px; position: relative; transition: 0.3s; cursor: pointer; }
        .toggle.on { background: var(--c-blue); }
        .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle.on::after { left: 22px; }

        .l-btn { padding: 8px 15px; border: 1.5px solid var(--c-blue); border-radius: 8px; color: var(--c-blue); background: none; font-weight: bold; cursor: pointer; }
        .l-btn.active { background: var(--c-blue); color: white; }

        .map-container { padding: 20px; overflow-y: auto; padding-bottom: 90px; }
        .levels-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .level-btn { aspect-ratio: 1; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; }
        .level-btn.completed { background: var(--c-green); color: white; }
        .level-btn.current { background: var(--c-blue); color: white; transform: scale(1.1); box-shadow: 0 0 15px rgba(0,51,102,0.3); }
        .level-btn.locked { background: var(--c-gray); color: #999; cursor: not-allowed; opacity: 0.6; }

        .leaderboard { max-height: 400px; overflow-y: auto; margin: 20px 0; }
        .leader-row { display: flex; justify-content: space-between; padding: 10px 15px; margin: 5px 0; background: white; border-radius: 10px; align-items: center; }
        .leader-row.you { background: var(--c-blue); color: white; }
        .leader-rank { font-weight: bold; width: 30px; }
        .leader-name { flex: 1; margin: 0 10px; }
        .leader-score { font-weight: bold; color: var(--c-gold); }
        
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .shop-item { background: white; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .shop-item:hover { transform: scale(1.05); }
        .shop-item.locked { opacity: 0.5; }
        .shop-price { color: var(--c-gold); font-weight: bold; margin-top: 5px; }
        
        .coin-animation { position: fixed; z-index: 10000; font-size: 24px; font-weight: bold; color: var(--c-gold); animation: coinBounce 1s ease-out forwards; pointer-events: none; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-body { background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .timer-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; color: var(--c-blue); font-weight: 600; font-variant-numeric: tabular-nums; }
        
        #scr-win { align-items: center; justify-content: center; text-align: center; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 1500; overflow: hidden; }
        #confetti-canvas { position: absolute; inset: 0; pointer-events: none; width: 100%; height: 100%; z-index: 1; }
        .win-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .win-title { font-size: 3.5rem; font-weight: 900; color: var(--c-blue); margin-bottom: 40px; transform: scale(0); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 2px 10px rgba(0,51,102,0.1); }
        .win-title.show { transform: scale(1); }
        .win-reward { color: var(--c-gold); font-size: 1.5rem; font-weight: bold; margin: 10px 0; }
        
        .btn-row { display: flex; gap: 20px; margin-top: 20px; }
        .big-btn { padding: 15px 30px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .big-btn:active { transform: scale(0.95); }
        .btn-menu { background: var(--c-gray); color: #555; }
        .btn-next { background: var(--c-blue); color: white; box-shadow: 0 8px 20px rgba(0,51,102,0.25); }
    </style>
</head>
<body>

<div id="app">
    <div class="top-ui" id="main-header">
        <div class="stats-bar">
            <div class="stat-item coins" id="coins-display">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                <span id="coins-count">0</span>
            </div>
            <div class="lives-pill" onclick="App.showTimers()">
                <svg width="20" height="20" fill="var(--c-red)" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="lives-count" style="font-weight: 800; color: var(--c-blue);">3</span>
            </div>
        </div>
        <div id="btn-back" style="display:none" onclick="App.nav('home')">
            <svg width="30" height="30" fill="var(--c-blue)" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>
    </div>

    <div id="scr-home" class="screen active">
        <div class="logo">Arrows</div>
        <div id="player-name" style="margin-bottom: 5px; font-weight: bold; color: var(--c-blue);"></div>
        <div id="lvl-label" style="margin-bottom: 30px; font-weight: bold; color: var(--c-blue); opacity: 0.6;">LEVEL 1</div>
        <div class="play-btn" onclick="App.play()">
            <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="board-zone"><div id="board"></div></div>
    </div>
    
    <div id="scr-win" class="screen">
        <canvas id="confetti-canvas"></canvas>
        <div class="win-content">
            <div id="win-msg" class="win-title">Victory!</div>
            <div id="win-reward" class="win-reward">+50 ðŸª™</div>
            <div class="btn-row">
                <button class="big-btn btn-menu" id="btn-win-menu" onclick="App.nav('home')">Menu</button>
                <button class="big-btn btn-next" id="btn-win-next" onclick="App.nextLvl()">Next</button>
            </div>
        </div>
    </div>

    <div id="scr-map" class="screen">
        <div class="map-container">
            <h2 style="color:var(--c-blue); text-align:center; margin:0 0 20px 0;" id="t-map">Level Map</h2>
            <div class="levels-grid" id="levels-grid"></div>
        </div>
    </div>

    <div id="scr-stats" class="screen" style="padding: 20px; overflow-y: auto;">
        <h2 style="color:var(--c-blue); text-align:center; margin:20px 0;" id="t-leaderboard">Leaderboard</h2>
        <div class="leaderboard" id="leaderboard-list"></div>
    </div>

    <div id="scr-shop" class="screen" style="padding: 20px; overflow-y: auto;">
        <h2 style="color:var(--c-blue); text-align:center; margin:20px 0;" id="t-shop">Shop</h2>
        <div class="shop-grid" id="shop-items"></div>
        <div style="text-align:center; margin-top:30px; color:#666; padding:20px;">
            <div id="t-comingsoon">ðŸŽ¨ New skins coming soon! ðŸš€</div>
            <div style="font-size:0.9rem; margin-top:10px;" id="t-shopdesc">Earn coins by completing levels and unlock awesome skins!</div>
        </div>
    </div>

    <div id="scr-set" class="screen">
        <div class="set-row"><span id="t-sound">Sound</span><div class="toggle" id="tog-sound" onclick="App.toggle('sound')"></div></div>
        <div class="set-row"><span id="t-vib">Vibration</span><div class="toggle" id="tog-vib" onclick="App.toggle('vib')"></div></div>
        <div class="set-row" style="flex-direction: column; gap: 15px; align-items: flex-start;">
            <span id="t-lang">Language</span>
            <div style="display: flex; gap: 8px;">
                <button class="l-btn" id="l-ru" onclick="App.setLang('ru')">RU</button>
                <button class="l-btn" id="l-en" onclick="App.setLang('en')">EN</button>
                <button class="l-btn" id="l-zh" onclick="App.setLang('zh')">ZH</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-icon" id="n-map" onclick="App.nav('map')">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M4 15h2v-2H4v2zm0 4h2v-2H4v2zm0-8h2V9H4v2zm4 4h12v-2H8v2zm0 4h12v-2H8v2zm0-8h12V9H8v2zM4 5h16V3H4v2z"/></svg>
        </div>
        <div class="nav-icon active" id="n-home" onclick="App.nav('home')">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        </div>
        <div class="nav-icon" id="n-stats" onclick="App.nav('stats')">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
        </div>
        <div class="nav-icon" id="n-shop" onclick="App.nav('shop')">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
        </div>
        <div class="nav-icon" id="n-set" onclick="App.nav('set')">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>
    </div>

    <div class="modal" id="modal-timers">
        <div class="modal-body">
            <h3 id="t-rec" style="color:var(--c-blue); margin-bottom:15px;">Recovery</h3>
            <div id="timers-list" style="margin:20px 0; max-height: 200px; overflow-y:auto;"></div>
            <button onclick="App.hideModal()" style="padding:12px 30px; background:var(--c-blue); color:white; border:none; border-radius:12px; font-weight:bold; font-size:16px; cursor:pointer;">OK</button>
        </div>
    </div>
</div>

<script>
// ====================== Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ˜ ======================
const GameStats = {
    userData: {
        coins: 0,
        maxLevel: 1,
        username: "Player",
        userId: null,
        skins: ["default"],
        selectedSkin: "default",
        completedLevels: new Set([1])
    },
    
    translations: {
        ru: {
            leaderboard: "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð»Ð¸Ð´ÐµÑ€Ð¾Ð²", shop: "ÐœÐ°Ð³Ð°Ð·Ð¸Ð½", comingsoon: "ðŸŽ¨ ÐÐ¾Ð²Ñ‹Ðµ ÑÐºÐ¸Ð½Ñ‹ ÑÐºÐ¾Ñ€Ð¾! ðŸš€",
            shopdesc: "Ð—Ð°Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð¼Ð¾Ð½ÐµÑ‚Ñ‹, Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ñ ÑƒÑ€Ð¾Ð²Ð½Ð¸, Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ ÐºÑ€ÑƒÑ‚Ñ‹Ðµ ÑÐºÐ¸Ð½Ñ‹!", map: "ÐšÐ°Ñ€Ñ‚Ð° ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹",
            coins: "ÐœÐ¾Ð½ÐµÑ‚Ñ‹", level: "Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ", you: "Ð’Ñ‹", rank: "ÐœÐµÑÑ‚Ð¾", name: "Ð˜Ð¼Ñ", score: "ÐžÑ‡ÐºÐ¸",
            loading: "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...", skin_default: "Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹", skin_fire: "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹", skin_ice: "Ð›ÐµÐ´ÑÐ½Ð¾Ð¹",
            skin_neon: "ÐÐµÐ¾Ð½Ð¾Ð²Ñ‹Ð¹", price: "Ð¦ÐµÐ½Ð°", buy: "ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ", owned: "Ð’Ð»Ð°Ð´ÐµÐµÑ‚Ðµ", select: "Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ",
            completed: "ÐŸÑ€Ð¾Ð¹Ð´ÐµÐ½Ð¾", current: "Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹", locked: "Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"
        },
        en: {
            leaderboard: "Leaderboard", shop: "Shop", comingsoon: "ðŸŽ¨ New skins coming soon! ðŸš€",
            shopdesc: "Earn coins by completing levels and unlock awesome skins!", map: "Level Map",
            coins: "Coins", level: "Level", you: "You", rank: "Rank", name: "Name", score: "Score",
            loading: "Loading...", skin_default: "Default", skin_fire: "Fire", skin_ice: "Ice",
            skin_neon: "Neon", price: "Price", buy: "Buy", owned: "Owned", select: "Select",
            completed: "Completed", current: "Current", locked: "Locked"
        },
        zh: {
            leaderboard: "æŽ’è¡Œæ¦œ", shop: "å•†åº—", comingsoon: "ðŸŽ¨ æ–°çš®è‚¤å³å°†æŽ¨å‡ºï¼ðŸš€",
            shopdesc: "é€šè¿‡å®Œæˆå…³å¡èµšå–é‡‘å¸å¹¶è§£é”ç‚«é…·çš®è‚¤ï¼", map: "å…³å¡åœ°å›¾",
            coins: "é‡‘å¸", level: "ç­‰çº§", you: "ä½ ", rank: "æŽ’å", name: "åå­—", score: "åˆ†æ•°",
            loading: "åŠ è½½ä¸­...", skin_default: "é»˜è®¤", skin_fire: "ç«ç„°", skin_ice: "å†°éœœ",
            skin_neon: "éœ“è™¹", price: "ä»·æ ¼", buy: "è´­ä¹°", owned: "å·²æ‹¥æœ‰", select: "é€‰æ‹©",
            completed: "å·²å®Œæˆ", current: "å½“å‰", locked: "å·²é”å®š"
        }
    },
    
    shopItems: [
        { id: "default", name: { ru: "Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹", en: "Default", zh: "é»˜è®¤" }, price: 0, color: "#003366" },
        { id: "fire", name: { ru: "ÐžÐ³Ð½ÐµÐ½Ð½Ñ‹Ð¹", en: "Fire", zh: "ç«ç„°" }, price: 500, color: "#ff4d4d" },
        { id: "ice", name: { ru: "Ð›ÐµÐ´ÑÐ½Ð¾Ð¹", en: "Ice", zh: "å†°éœœ" }, price: 750, color: "#3498db" },
        { id: "neon", name: { ru: "ÐÐµÐ¾Ð½Ð¾Ð²Ñ‹Ð¹", en: "Neon", zh: "éœ“è™¹" }, price: 1000, color: "#9b59b6" }
    ],
    
    init() {
        this.loadFromStorage();
        this.detectTelegramUser();
        this.updateUI();
    },
    
    detectTelegramUser() {
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            const user = tg.initDataUnsafe?.user;
            if (user) {
                this.userData.username = user.username ? `@${user.username}` : `${user.first_name}${user.last_name ? ' ' + user.last_name : ''}`;
                this.userData.userId = user.id;
                this.saveToLeaderboard();
            }
        }
        document.getElementById('player-name').textContent = this.userData.username;
    },
    
    loadFromStorage() {
        const saved = localStorage.getItem('arrows_stats');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.userData = { ...this.userData, ...data };
                if (data.completedLevels && Array.isArray(data.completedLevels)) {
                    this.userData.completedLevels = new Set(data.completedLevels);
                }
            } catch (e) {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸:', e);
            }
        }
    },
    
    saveToStorage() {
        const saveData = {
            ...this.userData,
            completedLevels: Array.from(this.userData.completedLevels)
        };
        localStorage.setItem('arrows_stats', JSON.stringify(saveData));
    },
    
    addCoins(amount) {
        this.userData.coins += amount;
        this.showCoinAnimation(amount);
        this.updateCoinsDisplay();
        this.saveToStorage();
        return this.userData.coins;
    },
    
    showCoinAnimation(amount) {
        const coin = document.createElement('div');
        coin.className = 'coin-animation';
        coin.textContent = `+${amount} ðŸª™`;
        coin.style.left = '50%';
        coin.style.top = '50%';
        coin.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(coin);
        setTimeout(() => coin.remove(), 1000);
    },
    
    completeLevel(level) {
        this.userData.completedLevels.add(level);
        if (!this.userData.completedLevels.has(level + 1)) {
            this.userData.completedLevels.add(level + 1);
        }
        this.saveToStorage();
    },
    
    isLevelUnlocked(level) {
        return this.userData.completedLevels.has(level);
    },
    
    updateLevel(level) {
        if (level > this.userData.maxLevel) {
            this.userData.maxLevel = level;
            this.saveToStorage();
            this.saveToLeaderboard();
        }
        this.updateLevelDisplay();
    },
    
    updateCoinsDisplay() {
        document.getElementById('coins-count').textContent = this.userData.coins;
    },
    
    updateLevelDisplay() {
        document.getElementById('level-count').textContent = this.userData.maxLevel;
    },
    
    updateUI() {
        this.updateCoinsDisplay();
        this.updateLevelDisplay();
    },
    
    saveToLeaderboard() {
        const leaderboard = JSON.parse(localStorage.getItem('arrows_leaderboard') || '[]');
        const userIndex = leaderboard.findIndex(u => u.userId === this.userData.userId);
        const userEntry = {
            userId: this.userData.userId,
            username: this.userData.username,
            score: this.userData.maxLevel,
            lastPlayed: Date.now()
        };
        if (userIndex !== -1) {
            if (userEntry.score > leaderboard[userIndex].score) {
                leaderboard[userIndex] = userEntry;
            }
        } else {
            leaderboard.push(userEntry);
        }
        leaderboard.sort((a, b) => b.score - a.score);
        const top50 = leaderboard.slice(0, 50);
        localStorage.setItem('arrows_leaderboard', JSON.stringify(top50));
    },
    
    loadLeaderboard() {
        const leaderboard = JSON.parse(localStorage.getItem('arrows_leaderboard') || '[]');
        const t = this.translations[App.state.lang] || this.translations.en;
        let html = '';
        if (leaderboard.length === 0) {
            html = `<div style="text-align:center; padding:40px; color:#999;">${t.loading}</div>`;
        } else {
            leaderboard.forEach((user, index) => {
                const isYou = user.userId === this.userData.userId;
                html += `<div class="leader-row ${isYou ? 'you' : ''}">
                    <div class="leader-rank">${index + 1}</div>
                    <div class="leader-name">${user.username}</div>
                    <div class="leader-score">${user.score} ${t.level}</div>
                </div>`;
            });
        }
        document.getElementById('leaderboard-list').innerHTML = html;
    },
    
    loadShop() {
        const t = this.translations[App.state.lang] || this.translations.en;
        let html = '';
        this.shopItems.forEach(item => {
            const owned = this.userData.skins.includes(item.id);
            const selected = this.userData.selectedSkin === item.id;
            const canBuy = this.userData.coins >= item.price;
            html += `<div class="shop-item ${!owned && !canBuy ? 'locked' : ''}" 
                onclick="GameStats.handleShopItem('${item.id}')"
                style="border: 2px solid ${selected ? item.color : 'transparent'}">
                <div style="width:60px;height:60px;margin:0 auto 10px;background:${item.color};border-radius:10px;"></div>
                <div style="font-weight:bold;">${item.name[t.lang] || item.name.en}</div>
                <div class="shop-price">${owned ? t.owned : `${item.price} ðŸª™`}</div>
            </div>`;
        });
        document.getElementById('shop-items').innerHTML = html;
    },
    
    handleShopItem(skinId) {
        const item = this.shopItems.find(s => s.id === skinId);
        const t = this.translations[App.state.lang] || this.translations.en;
        if (this.userData.skins.includes(skinId)) {
            this.userData.selectedSkin = skinId;
            this.saveToStorage();
            this.loadShop();
            this.applySkin();
            return;
        }
        if (this.userData.coins >= item.price) {
            if (confirm(`ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ "${item.name[t.lang] || item.name.en}" Ð·Ð° ${item.price} ðŸª™?`)) {
                this.userData.coins -= item.price;
                this.userData.skins.push(skinId);
                this.userData.selectedSkin = skinId;
                this.saveToStorage();
                this.updateUI();
                this.loadShop();
                this.applySkin();
            }
        } else {
            alert(`ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼Ð¾Ð½ÐµÑ‚! ÐÑƒÐ¶Ð½Ð¾ ÐµÑ‰Ðµ ${item.price - this.userData.coins} ðŸª™`);
        }
    },
    
    applySkin() {
        const item = this.shopItems.find(s => s.id === this.userData.selectedSkin);
        if (item) {
            document.documentElement.style.setProperty('--c-blue', item.color);
        }
    },
    
    loadLevelsMap() {
        const t = this.translations[App.state.lang] || this.translations.en;
        let html = '';
        const totalLevels = 50;
        for (let i = 1; i <= totalLevels; i++) {
const completed = this.userData.completedLevels.has(i);
            const current = i === App.state.maxLvl;
            const unlocked = this.isLevelUnlocked(i);
            let className = 'level-btn';
            if (completed) className += ' completed';
            if (current) className += ' current';
            if (!unlocked) className += ' locked';
            html += `<div class="${className}" onclick="GameStats.selectLevel(${i})">${i}</div>`;
        }
        document.getElementById('levels-grid').innerHTML = html;
    },
    
    selectLevel(level) {
        if (!this.isLevelUnlocked(level)) {
            const t = this.translations[App.state.lang] || this.translations.en;
            alert(`${t.locked}: Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ ${level}`);
            return;
        }
        App.play(level);
    }
};

// ====================== ÐšÐžÐÐ¤Ð•Ð¢Ð¢Ð˜ ======================
const Confetti = {
    canvas: null, ctx: null, w: 0, h: 0, particles: [], active: false,
    colors: ['#ff4d4d', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6', '#00cc99', '#ff6600'],
    init() {
        this.canvas = document.getElementById('confetti-canvas');
        this.ctx = this.canvas.getContext('2d');
        window.addEventListener('resize', () => this.resize());
    },
    resize() {
        const parent = this.canvas.parentElement;
        this.w = this.canvas.width = parent.offsetWidth;
        this.h = this.canvas.height = parent.offsetHeight;
    },
    start() {
        this.resize();
        this.active = true;
        this.particles = [];
        for(let i=0; i<150; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 25 + 10;
            this.particles.push({
                x: this.w / 2, y: this.h / 2,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                c: this.colors[Math.floor(Math.random() * this.colors.length)],
                s: Math.random() * 10 + 5,
                d: Math.random() * 0.04 + 0.95,
                r: Math.random() * 360, vr: (Math.random() - 0.5) * 10
            });
        }
        this.loop();
    },
    stop() { this.active = false; if(this.ctx) this.ctx.clearRect(0,0,this.w,this.h); },
    loop() {
        if(!this.active) return;
        this.ctx.clearRect(0,0,this.w,this.w);
        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.8;
            p.vx *= p.d; p.vy *= p.d;
            p.r += p.vr; p.s *= 0.995;
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            this.ctx.rotate(p.r * Math.PI / 180);
            this.ctx.fillStyle = p.c;
            this.ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
            this.ctx.restore();
            if(p.y > this.h + 50 || p.s < 1) this.particles.splice(i, 1);
        });
        if(this.particles.length > 0) requestAnimationFrame(() => this.loop());
        else this.active = false;
    }
};

// ====================== Ð“Ð•ÐžÐœÐ•Ð¢Ð Ð˜Ð¯ ======================
const Geo = {
    tracks: {
        'R': [[5,30], [40,30], [40,50], [1500,50]],
        'L': [[55,30], [20,30], [20,10], [-1500,10]],
        'U': [[30,55], [30,20], [10,20], [10,-1500]],
        'D': [[30,5], [30,40], [50,40], [50,1500]]
    },
    getPointAtDist(points, dist) {
        let currentDist = 0;
        for(let i=0; i<points.length-1; i++) {
            let dx = points[i+1][0]-points[i][0], dy = points[i+1][1]-points[i][1];
            let segLen = Math.hypot(dx, dy);
            if(currentDist + segLen >= dist) {
                let ratio = (dist - currentDist) / segLen;
                return { x: points[i][0] + dx * ratio, y: points[i][1] + dy * ratio, angle: Math.atan2(dy, dx) * 180 / Math.PI };
            }
            currentDist += segLen;
        }
        let last = points[points.length-1];
        return {x: last[0], y: last[1], angle: 0};
    },
    getSegmentPath(points, distStart, distEnd) {
        let d = "", currentDist = 0;
        let pStart = this.getPointAtDist(points, Math.max(0, distStart));
        d += `M ${pStart.x} ${pStart.y}`;
        for(let i=0; i<points.length-1; i++) {
            let segLen = Math.hypot(points[i+1][0]-points[i][0], points[i+1][1]-points[i][1]);
            if(currentDist + segLen > distStart && currentDist + segLen < distEnd) d += ` L ${points[i+1][0]} ${points[i+1][1]}`;
            currentDist += segLen;
        }
        let pEnd = this.getPointAtDist(points, distEnd);
        d += ` L ${pEnd.x} ${pEnd.y}`;
        return { d, head: pEnd };
    }
};

// ====================== ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ ÐšÐžÐ” ======================
const App = {
    state: { maxLvl: 1, lives: 3, timers: [], lang: 'ru', sound: true, vib: true, savedLevels: {} },
    curNum: 1,
    trans: {
        ru: { lang: "Ð¯Ð·Ñ‹Ðº", rec: "Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ", lvl: "Ð£Ð ÐžÐ’Ð•ÐÐ¬", sound: "Ð—Ð²ÑƒÐº", vib: "Ð’Ð¸Ð±Ñ€Ð°Ñ†Ð¸Ñ", heart: "Ð¡ÐµÑ€Ð´Ñ†Ðµ", menu: "ÐœÐµÐ½ÑŽ", next: "Ð”Ð°Ð»ÐµÐµ", map: "ÐšÐ°Ñ€Ñ‚Ð° ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹" },
        en: { lang: "Language", rec: "Recovery", lvl: "LEVEL", sound: "Sound", vib: "Vibration", heart: "Heart", menu: "Menu", next: "Next", map: "Level Map" },
        zh: { lang: "è¯­è¨€", rec: "æ¢å¤æ—¶é—´", lvl: "å…³å¡", sound: "å£°éŸ³", vib: "æŒ¯åŠ¨", heart: "å¿ƒ", menu: "èœå•", next: "ä¸‹ä¸€å…³", map: "å…³å¡åœ°å›¾" }
    },
    praise: {
        ru: ["ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾!", "Ð¡ÑƒÐ¿ÐµÑ€!", "ÐŸÐ¾Ð±ÐµÐ´Ð°!", "Ð“ÐµÐ½Ð¸Ð°Ð»ÑŒÐ½Ð¾!", "ÐšÐ»Ð°ÑÑ!", "Ð£Ñ€Ð°!", "Ð’ÐµÐ»Ð¸ÐºÐ¾Ð»ÐµÐ¿Ð½Ð¾!"],
        en: ["Excellent!", "Amazing!", "Victory!", "Genius!", "Great!", "Wow!", "Fantastic!"],
        zh: ["å¤ªæ£’äº†!", "å®Œç¾Ž!", "èƒœåˆ©!", "å¤©æ‰!", "å¥½æžäº†!", "å“‡!", "ç²¾å½©!"]
    },
    audioCtx: null,
    busy: false,

    init() {
        const d = localStorage.getItem('arrows_pro_v19');
        if (d) this.state = {...this.state, ...JSON.parse(d)};
        GameStats.init();
        this.updateUI();
        Confetti.init();
        setInterval(() => this.tick(), 1000);
        const unlock = () => {
            if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            window.removeEventListener('touchstart', unlock);
            window.removeEventListener('click', unlock);
        };
        window.addEventListener('touchstart', unlock);
        window.addEventListener('click', unlock);
    },

    save() { localStorage.setItem('arrows_pro_v19', JSON.stringify(this.state)); },

    updateUI() {
        const t = this.trans[this.state.lang];
        document.getElementById('lives-count').innerText = this.state.lives;
        document.getElementById('lvl-label').innerText = `${t.lvl} ${this.state.maxLvl}`;
        document.getElementById('t-sound').innerText = t.sound;
        document.getElementById('t-vib').innerText = t.vib;
        document.getElementById('t-lang').innerText = t.lang;
        document.getElementById('t-rec').innerText = t.rec;
        document.getElementById('t-map').innerText = t.map;
        const statsT = GameStats.translations[this.state.lang] || GameStats.translations.ru;
        document.getElementById('t-leaderboard').textContent = statsT.leaderboard;
        document.getElementById('t-shop').textContent = statsT.shop;
        document.getElementById('t-comingsoon').textContent = statsT.comingsoon;
        document.getElementById('t-shopdesc').textContent = statsT.shopdesc;
        document.getElementById('btn-win-menu').innerText = t.menu;
        document.getElementById('btn-win-next').innerText = t.next;
        document.getElementById('tog-sound').classList.toggle('on', this.state.sound);
        document.getElementById('tog-vib').classList.toggle('on', this.state.vib);
        document.querySelectorAll('.l-btn').forEach(b => b.classList.toggle('active', b.id === 'l-'+this.state.lang));
    },

    nav(scr) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-' + scr).classList.add('active');
        document.getElementById('main-header').style.visibility = (scr==='home' || scr==='game') ? 'visible' : 'hidden';
        document.getElementById('btn-back').style.display = (scr==='game') ? 'block' : 'none';
        document.querySelectorAll('.nav-icon').forEach(i => i.classList.toggle('active', i.id === 'n-'+scr));
        if(scr !== 'win') Confetti.stop();
        if(scr === 'map') GameStats.loadLevelsMap();
        else if(scr === 'stats') GameStats.loadLeaderboard();
        else if(scr === 'shop') GameStats.loadShop();
        document.querySelector('.board-zone').classList.remove('error-shake');
    },

    playAudio(type) {
        if (!this.state.sound || !this.audioCtx) return;
        const t = this.audioCtx.currentTime;
        const osc = this.audioCtx.createOscillator();
        const g = this.audioCtx.createGain();
        osc.connect(g); g.connect(this.audioCtx.destination);
        if (type === 'win') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, t);
            osc.frequency.exponentialRampToValueAtTime(1000, t + 0.1);
            g.gain.setValueAtTime(0.3, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
            osc.start(t); osc.stop(t + 0.3);
        } else if (type === 'err') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(50, t + 0.2);
            g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
            osc.start(t); osc.stop(t + 0.2);
        } else if (type === 'victory') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, t); osc.frequency.setValueAtTime(659.25, t + 0.1);
            osc.frequency.setValueAtTime(783.99, t + 0.2); osc.frequency.setValueAtTime(1046.50, t + 0.3);
            g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0.3, t + 0.4);
            g.gain.linearRampToValueAtTime(0, t + 0.8);
            osc.start(t); osc.stop(t + 0.8);
        }
    },

    vibrate(type) {
        if (!this.state.vib || !navigator.vibrate) return;
        if (type === 'win') navigator.vibrate(50);
        if (type === 'err') navigator.vibrate([50, 50, 50]);
        if (type === 'victory') navigator.vibrate([50, 30, 50, 30, 100]);
    },

    play(n = this.state.maxLvl) {
        if(this.state.lives <= 0) return this.showTimers();
        this.curNum = n; this.nav('game'); this.loadLvl(n);
    },

    nextLvl() { this.play(this.curNum + 1); },

    loadLvl(n) {
        const b = document.getElementById('board'); b.innerHTML = '';
        if(!this.state.savedLevels[n]) this.state.savedLevels[n] = this.generate(n);
        const data = this.state.savedLevels[n];
        const cs = b.offsetWidth / 5;
        data.forEach(a => {
            if(a.solved) return;
            const wrap = document.createElement('div');
            wrap.className = 'arrow-box'; wrap.style.width = wrap.style.height = cs + 'px';
            wrap.style.left = a.x * cs + 'px'; wrap.style.top = a.y * cs + 'px';
            const track = Geo.tracks[a.dir];
            const initialPath = Geo.getSegmentPath(track, 0, 65);
            wrap.innerHTML = `<svg class="arrow-svg" viewBox="0 0 60 60">
                <path class="p-line" d="${initialPath.d}" />
                <polygon class="p-head" points="-6,-6 6,0 -6,6" transform="translate(${initialPath.head.x},${initialPath.head.y}) rotate(${initialPath.head.angle})"/>
            </svg>`;
            wrap.onclick = () => this.move(a, wrap);
            b.appendChild(wrap);
        });
    },

    isSolvable(arrows) {
        let remaining = arrows.map(a => ({...a}));
        let madeProgress = true;
        while(remaining.length > 0 && madeProgress) {
            madeProgress = false;
            const removableIndex = remaining.findIndex(candidate => {
                const hitsSomething = remaining.some(other => 
                    other.id !== candidate.id && this.checkCollision(candidate, other)
                );
                return !hitsSomething;
            });
            if(removableIndex !== -1) {
                remaining.splice(removableIndex, 1);
                madeProgress = true;
            }
        }
        return remaining.length === 0;
    },

    generate(lvl) {
        let attempts = 0;
        while(attempts < 500) {
            attempts++;
            const arrows = [];
            const grid = Array(5).fill().map(() => Array(5).fill(false));
            const ds = [{id:'R', x:1, y:0}, {id:'L', x:-1, y:0}, {id:'U', x:0, y:-1}, {id:'D', x:0, y:1}];
            let s = (lvl * 12345) + attempts; 
            const rnd = () => { s = (s * 16807) % 2147483647; return (s - 1) / 2147483646; };
            let coords = [];
            for(let y=0; y<5; y++) for(let x=0; x<5; x++) coords.push({x,y});
            for (let i = coords.length - 1; i > 0; i--) {
                const j = Math.floor(rnd() * (i + 1));
                [coords[i], coords[j]] = [coords[j], coords[i]];
            }
            let targetCount = lvl === 1 ? 6 : Math.min(10 + Math.floor(lvl / 2), 24);
            let idCounter = 0;
            for(let i=0; i<coords.length; i++) {
                if(arrows.length >= targetCount) break;
                const pos = coords[i];
                const d = ds[Math.floor(rnd() * 4)];
                grid[pos.y][pos.x] = true;
                arrows.push({ id: idCounter++, x: pos.x, y: pos.y, dir: d.id, dx: d.x, dy: d.y, solved: false });
            }
            if(this.isSolvable(arrows)) return arrows;
        }
        return [
            { id: 0, x: 0, y: 0, dir: 'R', dx: 1, dy: 0, solved: false },
            { id: 1, x: 4, y: 0, dir: 'L', dx: -1, dy: 0, solved: false },
            { id: 2, x: 1, y: 1, dir: 'D', dx: 0, dy: 1, solved: false },
            { id: 3, x: 3, y: 1, dir: 'U', dx: 0, dy: -1, solved: false },
            { id: 4, x: 0, y: 3, dir: 'R', dx: 1, dy: 0, solved: false },
            { id: 5, x: 4, y: 3, dir: 'L', dx: -1, dy: 0, solved: false }
        ];
    },

    move(a, el) {
        if(this.busy) return;
        this.busy = true;
        const data = this.state.savedLevels[this.curNum];
        let hit = data.find(o => !o.solved && o.id !== a.id && this.checkCollision(a, o));
        const line = el.querySelector('.p-line');
        const head = el.querySelector('.p-head');
        const track = Geo.tracks[a.dir];
        const duration = hit ? 400 : 600; 
        if(!hit) { this.playAudio('win'); this.vibrate('win'); }
        let startTime = null;
        const animateStep = (time) => {
            if (!startTime) startTime = time;
            let p = (time - startTime) / duration;
            if (p > 1) p = 1;
            let distFactor;
            if (hit) {
                if (p < 0.4) distFactor = (p / 0.4) * 25; 
                else {
                    if(!this.hasHitSound && p >= 0.4) {
                        this.hasHitSound = true;
                        this.playAudio('err'); 
                        this.vibrate('err');
                        el.classList.add('error-arr');
                        document.querySelector('.board-zone').classList.add('error-shake');
                        setTimeout(() => {
                            document.querySelector('.board-zone').classList.remove('error-shake');
                            el.classList.remove('error-arr');
                        }, 500);
                    }
                    distFactor = 25 * (1 - ((p - 0.4) / 0.6)); 
                }
            } else distFactor = (p * p) * 800; 
            const currentHeadDist = 65 + distFactor;
            const currentTailDist = currentHeadDist - 65;
            const seg = Geo.getSegmentPath(track, currentTailDist, currentHeadDist);
            line.setAttribute('d', seg.d);
            head.setAttribute('transform', `translate(${seg.head.x},${seg.head.y}) rotate(${seg.head.angle})`);
            if (p < 1) requestAnimationFrame(animateStep);
            else {
                this.busy = false; this.hasHitSound = false;
                if (hit) {
                    const resetSeg = Geo.getSegmentPath(track, 0, 65);
                    line.setAttribute('d', resetSeg.d);
                    head.setAttribute('transform', `translate(${resetSeg.head.x},${resetSeg.head.y}) rotate(${resetSeg.head.angle})`);
                    this.loseLife();
                } else {
                    el.style.opacity = '0';
                    a.solved = true;
                    if(data.every(x => x.solved)) setTimeout(() => this.showWin(), 300);
                }
            }
        };
        this.hasHitSound = false;
        requestAnimationFrame(animateStep);
    },

    showWin() {
        if(this.curNum === this.state.maxLvl) this.state.maxLvl++;
        const coinsEarned = 50;
        const newCoins = GameStats.addCoins(coinsEarned);
        GameStats.updateLevel(this.state.maxLvl);
        GameStats.completeLevel(this.curNum);
        this.save();
        this.updateUI();
        document.getElementById('win-reward').textContent = `+${coinsEarned} ðŸª™`;
        const arr = this.praise[this.state.lang];
        const txt = arr[Math.floor(Math.random() * arr.length)];
        const title = document.getElementById('win-msg');
        title.innerText = txt;
        title.classList.remove('show');
        this.nav('win');
        setTimeout(() => {
            this.playAudio('victory');
            this.vibrate('victory');
            Confetti.start();
            title.classList.add('show');
        }, 100);
    },

    checkCollision(a, o) {
        if(a.dx !== 0 && a.y === o.y) {
            if(a.dx > 0 && o.x > a.x) return true;
            if(a.dx < 0 && o.x < a.x) return true;
        }
        if(a.dy !== 0 && a.x === o.x) {
            if(a.dy > 0 && o.y > a.y) return true;
            if(a.dy < 0 && o.y < a.y) return true;
        }
        return false;
    },

    loseLife() {
        if(this.state.lives > 0) {
            this.state.lives--;
            this.state.timers.push(Date.now() + 1200000);
            this.save(); this.updateUI(); 
            if(this.state.lives === 0) setTimeout(() => this.nav('home'), 500);
        }
    },

    tick() {
        const now = Date.now();
        const prevLives = this.state.lives;
        this.state.timers = this.state.timers.filter(t => {
            if(now >= t) { this.state.lives = Math.min(3, this.state.lives + 1); return false; }
            return true;
        });
        if(prevLives !== this.state.lives) { this.save(); this.updateUI(); }
        if(document.getElementById('modal-timers').style.display === 'flex') this.renderTimersList();
    },

    renderTimersList() {
        const list = document.getElementById('timers-list'); list.innerHTML = '';
        const now = Date.now(); const t = this.trans[this.state.lang];
        if(this.state.timers.length === 0) { list.innerHTML = `<div style="padding:10px; color:#aaa;">Full HP</div>`; return; }
        this.state.timers.forEach((end, i) => {
            const diff = Math.max(0, Math.floor((end - now) / 1000));
            const mm = Math.floor(diff / 60).toString().padStart(2, '0');
            const ss = (diff % 60).toString().padStart(2, '0');
            const div = document.createElement('div'); div.className = 'timer-row';
            div.innerHTML = `<span>${t.heart} ${i+1}</span><span>${mm}:${ss}</span>`;
            list.appendChild(div);
        });
    },

    toggle(k) { this.state[k] = !this.state[k]; this.save(); this.updateUI(); },
    setLang(l) { this.state.lang = l; this.save(); this.updateUI(); GameStats.loadShop(); GameStats.loadLeaderboard(); GameStats.loadLevelsMap(); },
    showTimers() { document.getElementById('modal-timers').style.display = 'flex'; this.renderTimersList(); },
    hideModal() { document.getElementById('modal-timers').style.display = 'none'; }
};

// ====================== Ð—ÐÐŸÐ£Ð¡Ðš ======================
window.onload = () => {
    App.init();
    GameStats.applySkin();
};
window.GameStats = GameStats;
</script>
</body>
</html>
